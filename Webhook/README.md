# Service Account Validation Webhook

This Webhook handles the addition of imagePullSecrets to ServiceAccount specified in env variable and creation of Registry Credentials Secret in namespaces which contains the credentials to pull secret from authenticated private docker registry.

## Prerequisites
* Kubernetes 1.9.0 or above with the admissionregistration.k8s.io/v1beta1 API enabled.
You can verify with following command. If you don't have a K8s cluster you can use [Kind](https://kind.sigs.k8s.io/).

```kubectl api-versions | grep admissionregistration.k8s.io/v1beta1```
* Authenticated private docker registry. 
* Golang (if you need to custom build).

## Install
A Validation webhook controller should be run on https with signed certs so that api server can trust these endpoint and send the requests. You can generate these signed certs with the following command.

```bash generate_certs.sh --service webhook --namespace webhook --certSecret cert --keySecret key```

This command will generate the signed certs, secrets in the specified namespace and also updates the ```manifest.yaml```.

Then you can install the webhook server using following command.

```kubectl apply -f manifest.yaml```

To delete the all the resources and certs generated by above you can use the following command. 

```bash generate_certs.sh --service webhook --namespace webhook --certSecret cert --keySecret key --delete true```

You can configure the webhook server Host, port, etc by specifying in the following environment variables. The following values are default values which webhook is using. You can change accordingly as per your requirement.

```
env:
- name: HOST
  value: "0.0.0.0"  # Change the value to run the server on different host
- name: PORT
  value: "8888"     # Change the value to run the server on different port
- name: TLSCERT     
  value: "/etc/webhook/certs/cert.pem" # Path to Certificate location 
- name: TLSKEY     
  value: "/etc/webhook/certs/key.pem" # Path to key location
- name: DEBUG
  value: "false" # Keep true to run server in debug mode
- name: JSONLOG
  value: "false" # Keep true to print logs in JSON format
```

## Build

To customize the code and run your changes.

```
git clone https://github.com/PradeepTammali/authz-docker-registry.git
cd authz-docker-registry/Webhook
go build -o webhook
./webhook
```

### Blog:

https://medium.com/@pradeeptammaliwork/docker-registry-service-account-validation-1880e18037c9
